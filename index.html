<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
        <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
        <script src="res.min.js"></script>
        <!--<script src="jquery.js"></script>-->
        <style>
            *:not(input[type="text"]):not(input[type="number"]) {
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
                box-sizing: border-box;
            }
            html, body {
                margin: 0;
                padding: 0;
                overflow: visible;
                background: black;
                font-family: Arial, Verdana, sans-serif;
                line-height: 1;
                text-transform: uppercase;
                color: white;
                text-align: center;
                font-size: 10px;
            }
            @media (max-width: 767px) {
              html, body {
                font-size: 8px;
              }
            }

            button {
              font-size: 3em;
              color: white;
              background: #72af5f;
              border: 0;
              -webkit-appearance: none;
              padding: .2em .5em;
              text-transform: uppercase;
            }

            #game {
                display: table;
                position: absolute;
                table-layout: fixed;
            }
            #game > div {
              display: table-cell;
              vertical-align: middle;
            }


            #win h1 {
              font-size: 7em;
              margin: .3em 0;
            }
            #win h2 {
              color: #72af5f;
              font-size: 4em;
              font-weight: normal;
              margin: 0 0 1em;
            }
            #win h3 {
              font-size: 3em;
              font-weight: normal;
              margin: 1em 0;
              line-height: 1.3;
            }
            #win > *:last-child {
              margin-bottom: 0;
            }

            #form h3 {
              font-size: 3em;
              line-height: 1.3;
              font-weight: normal;
              margin: 0;
              color: #d24a43;
            }
            #form h1 {
              font-size: 5em;
              margin: .5em 0;
            }
            #form .inputs input {
              background-color: white;
              border: 2px solid #b84140;
              color: #b84140 !important;
              font-size: inherit;
              line-height: 1;
              margin: 0 .1em;
              text-align: center;
              padding: 0;
            }
            #input_x,
            #input_y {
              width: 1em;
            }
            #input_z,
            #input_cloud {
              width: 1.6em;
            }
            #form .image {
              background: transparent url('hashtag.png') no-repeat top left;
              background-size: cover;
              width: 40em;
              height: 7.6em;
              display: block;
              margin: 1.5em auto;
            }
            .truefalse h2 {
              font-size: 4em;
              color: #d24a43;
              font-weight: normal;
              line-height: 1.3;
              margin: 0;
            }
            .truefalse h1 {
              font-size: 5em;
              line-height: 1.3;
              margin: .3em 0;
            }
            .truefalse h1 b {
              font-size: 2em;
            }
            .truefalse button {
              font-size: 5em;
            }
            #false h1 {
              margin: 1em 0;
            }
        </style>
    </head>
    <body>
        <div id="game">
          <canvas id="c"></canvas>

          <div id="win" style="display: none">
            <h2>Ваше время <span id="yourtime"></span></h2>
            <h3>Результат есть.<br />Сделай скриншот и опубликуй его в&nbsp;инстаграм с этим хештегом</h3>
            <h1>#2015ARRULIT</h3>
            <h3>И жди заслуженного приза!<br />Удачи!</h3>
          </div>

          <div id="form" style="display: none">
            <h3>
              Вставь найденные<br />
              На трассе данные<br />
              Получи хештег<br />
              И дату мероприятия
            </h3>
            <div class="image"></div>
            <h1 class="inputs">#0<input type="text" autofocus="true" inputmode="numeric" pattern="[0-9]*" id="input_x" maxlength="1" tabIndex="1" />0<input type="text" inputmode="numeric" pattern="[0-9]*" id="input_y" maxlength="1" tabIndex="2" /><input type="text" inputmode="numeric" pattern="[0-9]*" id="input_z" maxlength="2" tabIndex="3" /><input type="text" id="input_cloud" maxlength="2" tabIndex="4" />RULIT</h1>
            <button>Проверить</button>
          </div>

          <div class="truefalse" id="true" style="display: none">
            <h2>Поздравляю!<br />Тебе удалось!</h2>
            <h1>Дата мероприятия:<br /><b>04-09-2015</b></h1>
            <button autofocus="true">Далее</button>
          </div>

          <div class="truefalse" id="false" style="display: none">
            <h2>Не угадал</h2>
            <h1>Соберись,<br />и попробуй ещё раз</h1>
            <button autofocus="true">Повторить</button>
          </div>
        </div>

        <script type="text/javascript">
          var game = (function(){
              var isMobile = false;
              if( /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
                isMobile = true;
              }

              var dpi = res.dpi();

              var getClientSize = function(){
                var clientWidth = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
                var clientHeight = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);

                return {width: clientWidth, height: clientHeight};
              }

              var getGameSize = function(){
                var clientSize = getClientSize();
                var clientWidth = clientSize.width;
                var clientHeight = clientSize.height;

                var ratio = clientHeight / clientWidth;

                var newWidth = dpi > 100 ? 640 : 500;
                var newHeight = 2 * Math.round((ratio * newWidth) / 2);
                if (!isMobile){
                  newWidth = 800;
                  newHeight = 600;
                }

                return {width: newWidth, height: newHeight};
              }

              var getGameScale = function(){
                return getGameSize().width / 800;
              }

              var getCarScale = function(){
                return getGameScale() * 0.8;
              }

              var canvasObj = $("#c");

              var r = Math.random;

              // -----------------------------
              // ---  closure scoped vars  ---
              // -----------------------------
              var canvas;
              var context;
              var keys = [];
              var startTime;
              var lastDelta = 0;
              var currentTimeString = "";
              var timeToFade = 0.4 * 30;
              var timeToFadeOrig = timeToFade;
              var finishOpacity = 0;
              var prevFrameHeight = 0;
              var pauseResults = false;

              window.pos = {x: 0, y: 0};
              var $game = $('#game');

              var roadParam = {
                  maxHeight: 900,
                  maxCurve:  700,
                  length:    2,
                  curvy:     0,
                  mountainy: 4,
                  zoneSize:  300
              }

              var road = [];
              var roadSegmentSize = 5;
              var numberOfSegmentPerColor = 10;

              var carScale = getCarScale();

              var gameSize = getGameSize();

              var gameWidth = gameSize.width;
              var gameHeight = gameSize.height;


              var render = {
                  width: gameWidth,
                  height: gameHeight,
                  depthOfField: 150,
                  camera_distance: 15,
                  camera_height: 180
              };

              var player = {
                  position: 10,
                  speed: 0,
                  acceleration: 0.05,
                  deceleration: 0.3,
                  breaking: 0.6,
                  turning: 9.0,
                  posx: 0,
                  maxSpeed: 15
              };

              var splashInterval;
              var gameInterval;

              // Straight
              var car = {
                  x: 0,
                  y: 980,
                  w: 296,
                  h: 200
              };
              // Left
              var car_4 = {
                  x: 0,
                  y: 780,
                  w: 324,
                  h: 200
              };
              // Right
              var car_8 = {
                  x: 0,
                  y: 1180,
                  w: 308,
                  h: 200
              };

              var hashtag = {
                x: 0,
                y: 1381,
                w: 600,
                h: 114
              };

              var background = {
                  x: 0,
                  y: 9,
                  w: 320,
                  h: 120
              };

              var background_orig = {
                  x: 472,
                  y: 9,
                  w: 320,
                  h: 120
              };

              var tree = {
                  x: 321,
                  y: 9,
                  w: 23,
                  h: 50
              };
              var rock = {
                  x: 345,
                  y: 9,
                  w: 11,
                  h: 14
              };

              var logo = {
                  x: 161,
                  y: 39,
                  w: 115,
                  h: 20
              };

              var billboards = [
                  {
                      x: 0,
                      y: 180,
                      w: 372,
                      h: 300
                  },
                  {
                      x: 372,
                      y: 180,
                      w: 413,
                      h: 300
                  },
                  {
                      x: 0,
                      y: 480,
                      w: 372,
                      h: 300
                  },
                  {
                      x: 372,
                      y: 480,
                      w: 511,
                      h: 300
                  }
              ]
              // -----------------------------
              // -- closure scoped function --
              // -----------------------------

              //initialize the game
              var init = function(){
                  // configure canvas
                  canvas = canvasObj.get(0);
                  context = canvas.getContext('2d');

                  var gameSize = getGameSize();
                  canvas.width = gameSize.width;
                  canvas.height = gameSize.height;

                  $game.css({
                    width: gameSize.width,
                    height: gameSize.height
                  });

                  resize();
                  $(window).resize(resize);

                  //register key handeling:
                  $(document).keydown(function(e){
                      keys[e.keyCode] = true;

                      window.activated = true;
                  });
                  $(document).keyup(function(e){
                      keys[e.keyCode] = false;

                      switch (e.keyCode) {
                          case 49:
                              render.camera_distance++;
                              break;
                          case 50:
                              --render.camera_distance;
                              break;
                          case 51:
                              render.camera_height = render.camera_height + 10;
                              break;
                          case 52:
                              render.camera_height = render.camera_height - 10;
                              break;
                      }

                      window.activated = false;
                  });

                  $(document).on('touchstart', function(e){
                    var clientSize = getClientSize();
                    var screenCenter = parseInt(clientSize.width / 2);
                    var currentX = e.originalEvent.touches[0].clientX;

                    if(currentX > screenCenter){
                      window.turnRight = true;
                      window.turnLeft = false;
                    } else {
                      window.turnLeft = true;
                      window.turnRight = false;
                    }
                    window.activated = true;
                  });
                  $(document).on('touchend', function(e){
                    window.turnLeft = false;
                    window.turnRight = false;
                    window.activated = false;
                  });
                  generateRoad();
              };

              //renders Splash Frame
              var renderSplashFrame = function(){
                  var splashHeight, splashWidth, top, left;

                  context.fillStyle = "rgb(0,0,38)";
                  context.fillRect(0, 0, render.width, render.height);

                  gameSize = getGameSize();
                  var splashRatio = 600/800;
                  if (gameSize.width > gameSize.height) {
                    splashWidth = gameSize.height / splashRatio;
                    splashHeight = gameSize.height;
                  } else {
                    splashWidth = gameSize.width;
                    splashHeight = gameSize.width * splashRatio;
                  }

                  top = (gameSize.height - splashHeight) / 2;
                  left = (gameSize.width - splashWidth) / 2;

                  context.drawImage(spritesheet, 372, 780, 800, 600, left, top, splashWidth, splashHeight);

                  if(window.activated){
                      clearInterval(splashInterval);
                      gameInterval = setInterval(renderGameFrame, 30);
                      startTime = new Date();
                  }
              }

              var deltaSlow = dpi > 100 ? 243 : 180;
              if (!isMobile) deltaSlow = 325;

              // var initFinish = function(){
              //   var pointerEventToXY = function(e){
              //     var out = {x:0, y:0};
              //
              //     if(e.type == 'touchstart' || e.type == 'touchmove' || e.type == 'touchend' || e.type == 'touchcancel'){
              //       var touch = e.originalEvent.touches[0] || e.originalEvent.changedTouches[0];
              //       out.x = touch.pageX;
              //       out.y = touch.pageY;
              //     } else if (e.type == 'mousedown' || e.type == 'mouseup' || e.type == 'mousemove' || e.type == 'mouseover'|| e.type=='mouseout' || e.type=='mouseenter' || e.type=='mouseleave' || e.type=='click') {
              //       out.x = e.pageX;
              //       out.y = e.pageY;
              //     }
              //
              //     out.x -= canvas.offsetLeft;
              //     out.y -= canvas.offsetTop;
              //
              //     return out;
              //   };
              //
              //
              //   var setMousePos = function (e) {
              //     window.pos = pointerEventToXY(e);
              //   }
              //
              //   $(document).on('touchstart', setMousePos);
              //   $(document).on('click', setMousePos);
              // }

              //renders one frame
              var renderGameFrame = function(){

                  // Clean screen
                  context.fillStyle = "#dc9";
                  context.fillRect(0, 0, render.width, render.height);

                  // --------------------------
                  // -- Update the car state --
                  // --------------------------

                  if (Math.abs(lastDelta) > deltaSlow){
                      if (player.speed > 3) {
                          player.speed -= 0.2;
                      }
                  } else {
                      // read acceleration controls
                      // if (keys[38] || keys[0]) { // 38 up
                          //player.position += 0.1;
                          player.speed += player.acceleration;
                      // } else if (keys[40]) { // 40 down
                      //     player.speed -= player.breaking;
                      // } else {
                      //     player.speed -= player.deceleration;
                      // }
                  }
                  player.speed = Math.max(player.speed, 0); //cannot go in reverse
                  player.speed = Math.min(player.speed, player.maxSpeed); //maximum speed
                  player.position += player.speed;

                  var carPosY = render.height / 2 + car.h * getCarScale() * 0.15;

                  // car turning
                  if (keys[37] || window.turnLeft) {
                      // 37 left
                      if(player.speed > 0){
                          player.posx -= player.turning;
                      }
                      var carSprite = {
                          a: car_4,
                          x: (render.width - car_4.w * carScale) / 2,
                          y: carPosY
                      };
                  } else if (keys[39] || window.turnRight) {
                      // 39 right
                      if(player.speed > 0){
                          player.posx += player.turning;
                      }
                      var carSprite = {
                          a: car_8,
                          x: (render.width - car_8.w * carScale) / 2,
                          y: carPosY
                      };
                  } else {
                      var carSprite = {
                          a: car,
                          x: (render.width - car.w * carScale) / 2,
                          y: carPosY
                      };
                  }


                  drawBackground(-player.posx);

                  var spriteBuffer = [];

                  // --------------------------
                  // --   Render the road    --
                  // --------------------------
                  var absoluteIndex = Math.floor(player.position / roadSegmentSize);

                  var currentSegmentIndex    = (absoluteIndex - 2) % road.length;
                  var currentSegmentPosition = (absoluteIndex - 2) * roadSegmentSize - player.position;
                  var currentSegment         = road[currentSegmentIndex];

                  var lastProjectedHeight     = Number.POSITIVE_INFINITY;
                  var probedDepth             = 0;
                  var counter                 = absoluteIndex % (2 * numberOfSegmentPerColor); // for alternating color band

                  var playerPosSegmentHeight     = road[absoluteIndex % road.length].height;
                  var playerPosNextSegmentHeight = road[(absoluteIndex + 1) % road.length].height;
                  var playerPosRelative          = (player.position % roadSegmentSize) / roadSegmentSize;
                  var playerHeight               = render.camera_height + playerPosSegmentHeight + (playerPosNextSegmentHeight - playerPosSegmentHeight) * playerPosRelative;

                  var baseOffset                 =  currentSegment.curve + (road[(currentSegmentIndex + 1) % road.length].curve - currentSegment.curve) * playerPosRelative;

                  lastDelta = player.posx - baseOffset*2;

                  var iter = render.depthOfField;
                  while (iter--) {
                      // Next Segment:
                      var nextSegmentIndex       = (currentSegmentIndex + 1) % road.length;
                      var nextSegment            = road[nextSegmentIndex];

                      var startProjectedHeight = Math.floor((playerHeight - currentSegment.height) * render.camera_distance / (render.camera_distance + currentSegmentPosition));
                      var startScaling         = 30 / (render.camera_distance + currentSegmentPosition);

                      var endProjectedHeight   = Math.floor((playerHeight - nextSegment.height) * render.camera_distance / (render.camera_distance + currentSegmentPosition + roadSegmentSize));
                      var endScaling           = 30 / (render.camera_distance + currentSegmentPosition + roadSegmentSize);

                      var currentHeight        = Math.min(lastProjectedHeight, startProjectedHeight);
                      var currentScaling       = startScaling;

                      if(currentHeight > endProjectedHeight){
                          var drw = function (position1, scale1, offset1, position2, scale2, offset2, alternate, finishStart){}
                          drawSegment(
                              render.height / 2 + currentHeight,
                              currentScaling, currentSegment.curve - baseOffset - lastDelta * currentScaling,
                              render.height / 2 + endProjectedHeight,
                              endScaling,
                              nextSegment.curve - baseOffset - lastDelta * endScaling,
                              counter < numberOfSegmentPerColor, currentSegmentIndex == 2 || currentSegmentIndex == (roadParam.length-render.depthOfField));
                      }
                      if(currentSegment.sprite){
                          spriteBuffer.push({
                              y: render.height / 2 + startProjectedHeight,
                              x: render.width / 2 - currentSegment.sprite.pos * render.width * currentScaling + /* */currentSegment.curve - baseOffset - (player.posx - baseOffset*2) * currentScaling,
                              ymax: render.height / 2 + lastProjectedHeight,
                              s: 2.5*currentScaling,
                              i: currentSegment.sprite.type});
                      }


                      lastProjectedHeight    = currentHeight;

                      probedDepth            = currentSegmentPosition;

                      currentSegmentIndex    = nextSegmentIndex;
                      currentSegment         = nextSegment;

                      currentSegmentPosition += roadSegmentSize;

                      counter = (counter + 1) % (2 * numberOfSegmentPerColor);
                  }

                  while(sprite = spriteBuffer.pop()) {
                      drawSprite(sprite);
                  }

                  // --------------------------
                  // --     Draw the car     --
                  // --------------------------
                  drawImage(carSprite.a, carSprite.x, carSprite.y, carScale);

                  // --------------------------
                  // --     Draw the hud     --
                  // --------------------------
                  var passed = Math.round(absoluteIndex/(roadParam.length-render.depthOfField)*100);
                  if (passed > 100)
                    passed = 100;
                  var percentsPassed = ""+passed+"%";

                  if (passed <= 100 && !pauseResults) {
                    var now = new Date();
                    var diff = now.getTime() - startTime.getTime();

                    var min = Math.floor(diff / 60000);

                    var sec = Math.floor((diff - min * 60000) / 1000);
                    if(sec < 10) sec = "0" + sec;

                    var mili = Math.floor(diff - min * 60000 - sec * 1000);
                    if(mili < 100) mili = "0" + mili;
                    if(mili < 10) mili = "0" + mili;

                    currentTimeString = ""+min+":"+sec+"."+mili;

                    if (passed == 100)
                      pauseResults = true;
                  }



                  drawText(currentTimeString, {x: gameWidth / 2, y: 0, size: 30, color: 'white', align: 'center', font: 'Courier New', bold: true});
                  drawText(percentsPassed, {x: gameWidth - 10, y: 0, size: 30, color: 'white', align: 'end', font: 'Courier New', bold: true});

                  // drawString(currentTimeString, {x: 1, y: 1});
                  var speed = Math.round(player.speed / player.maxSpeed * 200);
                  // drawString(""+speed+"mph", {x: 1, y: 10});
                  // drawString(String(window.debugText || '----'), {x: 1, y: 20});
                  // drawString("CAM DIST: " + String(render.camera_distance), {x: 1, y: 30});
                  // drawString("CAM HEIGHT: " + String(render.camera_height), {x: 1, y: 40});
                  // drawString("LAST DELTA: " + String(lastDelta), {x: 1, y: 50});

                  // drawString("W: " + String(gameWidth), {x: 1, y: 10});
                  // drawString("H: " + String(gameHeight), {x: 1, y: 20});
                  // drawString("DPI: " + String(dpi), {x: 1, y: 30});
                  // drawString("DELTA: " + String(lastDelta), {x: 1, y: 40});
                  // drawString("DLTSL: " + String(deltaSlow), {x: 1, y: 50});

                  // Check final
                  if(absoluteIndex >= roadParam.length-render.depthOfField-1){
                      opacity = (timeToFadeOrig - timeToFade) / timeToFadeOrig;
                      context.fillStyle = 'rgba(0,0,0,'+opacity+')';
                      context.fillRect(0, 0, render.width, render.height);

                      if (--timeToFade <= 0) {
                        clearInterval(gameInterval);
                        window.jumpNext = function (e) {
                          console.log(e.target, this);
                        }

                        $('#yourtime').html(currentTimeString);
                        canvasObj.hide();
                        $('#form').fadeIn().css('display', 'table-cell');

                        $('#form input').on('input', function () {
                          var $nextInput = $('[tabindex="' + (this.tabIndex + 1) +'"]');

                          if (this.value.length === this.maxLength)
                            $nextInput.focus();
                        });

                        var checkForm = function () {
                          var input_x = $('#input_x').val();
                          var input_y = $('#input_y').val();
                          var input_z = $('#input_z').val();
                          var input_cloud = $('#input_cloud').val().toUpperCase();

                          if (input_x == 4 && input_y == 9 && input_z == 15 && input_cloud == 'AR')
                            $('#form').fadeOut({
                              complete: function() {
                                $('#true').fadeIn();
                              }
                            });
                          else
                            $('#form').fadeOut({
                              complete: function() {
                                $('#false').fadeIn();
                              }
                            });
                        }

                        $('#form').on('keyup', function (e) {
                          if (e.keyCode == 13) checkForm();
                        });

                        $('#form button').on('click', checkForm);

                        $('#false button').on('click', function () {
                          window.location.reload();
                        });

                        $('#true button').on('click', function () {
                          $('#true').fadeOut({
                            complete: function() {
                              $('#win').fadeIn();
                            }
                          });
                        });
                      }
                  }
              };

              // var renderFinishFrame = function() {
              //   // Clean screen
              //   context.fillStyle = "#000";
              //   context.fillRect(0, 0, render.width, render.height);
              //   if (++timeToFade <= timeToFadeOrig) {
              //     context.globalAlpha = timeToFade/timeToFadeOrig;
              //   }
              //
              //   var scale = getGameScale();
              //   var size = 30 * scale;
              //
              //   var imageW = hashtag.w * scale;
              //   var imageH = hashtag.h * scale;
              //   var imageX = (gameWidth - imageW) / 2;
              //   var imageY = (gameHeight - imageH) / 2;
              //
              //   var repeatWidth = 300 * scale;
              //   var repeatHeight = 50 * scale;
              //   var repeatX = (gameWidth - repeatWidth) / 2;
              //   var repeatY = imageY + imageH + 20 * scale;
              //
              //   var titleX = repeatX + (repeatWidth / 2);
              //   var titleY = repeatY + 7 * scale;
              //
              //   var timeStringX = gameWidth / 2;
              //   var timeStringY = imageY - size - 25 * scale;
              //
              //   drawImage(hashtag, imageX, imageY, scale);
              //
              //   context.fillStyle = "#006600";
              //   context.fillRect(repeatX, repeatY, repeatWidth, repeatHeight);
              //   drawText("Ещё раз", { x: titleX, y: titleY, size: size, align: 'center' });
              //
              //   drawText("ВАШЕ ВРЕМЯ " + (currentTimeString || '01:12.351'), { x: timeStringX, y: timeStringY, size: size, align: 'center' });
              //
              //   var x = window.pos.x;
              //   var y = window.pos.y;
              //
              //   // if (x >= repeatX && x <= (repeatX + repeatWidth) && y >= repeatY && y <= (repeatY + repeatHeight)) {
              //   //   window.location.reload();
              //   //   window.pos = {x: 0, y: 0};
              //   // }
              // }


              // Drawing primitive
              var drawImage = function(image, x, y, scale){
                  context.drawImage(spritesheet,  image.x, image.y, image.w, image.h, x, y, scale*image.w, scale*image.h);
              };
              var drawSprite = function(sprite){
                  //if(sprite.y <= sprite.ymax){
                      var destY = sprite.y - sprite.i.h * sprite.s;
                      if(sprite.ymax < sprite.y) {
                          var h = Math.min(sprite.i.h * (sprite.ymax - destY) / (sprite.i.h * sprite.s), sprite.i.h);
                      } else {
                          var h = sprite.i.h;
                      }
                      //sprite.y - sprite.i.h * sprite.s
                      if(h > 0) context.drawImage(spritesheet,  sprite.i.x, sprite.i.y, sprite.i.w, h, sprite.x, destY, sprite.s * sprite.i.w, sprite.s * h);
                  //}
              };

              var drawSegment = function (position1, scale1, offset1, position2, scale2, offset2, alternate, finishStart){
                  var grass     = (alternate) ? "#eda" : "#dc9";
                  var border    = (alternate) ? "#e00" : "#fff";
                  var road      = "#777";
                  var lane      = (alternate) ? "#fff" : "#777";

                  if(finishStart){
                      road = "#fff";
                      lane = "#fff";
                      border = "#fff";
                  }


                  //draw grass:
                  context.fillStyle = grass;
                  context.fillRect(0,position2,render.width,(position1-position2));

                  // draw the road
                  drawTrapez(position1, scale1, offset1, position2, scale2, offset2, -0.5, 0.5, road);

                  //draw the road border
                  drawTrapez(position1, scale1, offset1, position2, scale2, offset2, -0.5, -0.47, border);
                  drawTrapez(position1, scale1, offset1, position2, scale2, offset2, 0.47,   0.5, border);

                  // draw the lane line
                  drawTrapez(position1, scale1, offset1, position2, scale2, offset2, -0.18, -0.15, lane);
                  drawTrapez(position1, scale1, offset1, position2, scale2, offset2,  0.15,  0.18, lane);
              }

              var drawTrapez = function(pos1, scale1, offset1, pos2, scale2, offset2, delta1, delta2, color){
                  var demiWidth = render.width / 2;

                  context.fillStyle = color;
                  context.beginPath();
                  context.moveTo(demiWidth + delta1 * render.width * scale1 + offset1, pos1);
                  context.lineTo(demiWidth + delta1 * render.width * scale2 + offset2, pos2);
                  context.lineTo(demiWidth + delta2 * render.width * scale2 + offset2, pos2);
                  context.lineTo(demiWidth + delta2 * render.width * scale1 + offset1, pos1);
                  context.fill();
              }

              var drawBackground = function(position) {
                  var first = position / 7 % (background.w);
                  drawImage(background_orig, first-background.w +1, 0, 1);
                  drawImage(background_orig, first+background.w -1, 0, 1);
                  drawImage(background_orig, first+background.w*2 -2, 0, 1);
                  drawImage(background, first, 0, 1);
              }

              var drawString = function(string, pos) {
                  string = string.toUpperCase();
                  var cur = pos.x;
                  for(var i=0; i < string.length; i++) {
                      context.drawImage(spritesheet, (string.charCodeAt(i) - 32) * 8, 0, 8, 8, cur, pos.y, 8, 8);
                      cur += 8;
                  }
              }

              var getGameScale = function(){
                return getGameSize().width / 800;
              }
              var drawText = function(string, options) {
                var fontSize = (options.size || 20) * getGameScale();
                var fontFamily = options.font || 'Arial';

                context.font = (options.bold ? 'bold ' : '') + fontSize + "px " + fontFamily;
                context.textAlign = options.align || "start";
                context.fillStyle = options.color || 'white';
                context.fillText(string, options.x, options.y + fontSize);
              }
              function resize(){
                  var gameSize = getGameSize();
                  var clientSize = getClientSize();

                  if (isMobile) {
                    render.width = gameSize.width;
                    render.height = gameSize.height;

                    gameWidth = gameSize.width;
                    gameHeight = gameSize.height;

                    canvas.width = gameSize.width;
                    canvas.height = gameSize.height;
                    context.width = gameSize.width;
                    context.height = gameSize.height;

                    $game.css({
                      width: gameSize.width,
                      height: gameSize.height
                    });
                  }

                  if (clientSize.width / clientSize.height > render.width / render.height) {
                      var scale = clientSize.height / render.height;
                  }
                  else {
                      var scale = clientSize.width / render.width;
                  }

                  var transform = "scale(" + scale + ")";
                  if (isMobile) $game.css("MozTransform", transform).css("transform", transform).css("WebkitTransform", transform);
                  $game.css({
                      top: (scale - 1) * render.height / 2 + (clientSize.height - render.height * scale) / 2,
                      left: (scale - 1) * render.width / 2 + (clientSize.width - render.width * scale) / 2
                  });
              };

              // -------------------------------------
              // ---  Generates the road randomly  ---
              // -------------------------------------
              var generateRoad = function(){
                  var currentStateH = 0; //0=flat 1=up 2= down
                  var transitionH = [[0,1,2],[0,2,2],[0,1,1]];

                  var currentStateC = 0; //0=straight 1=left 2= right
                  var transitionC = [[0,1,2],[0,2,2],[0,1,1]];

                  var currentHeight = 0;
                  var currentCurve  = 0;

                  var zones     = roadParam.length;
                  while(zones--){
                      // Generate current Zone

                      var finalHeight;
                      switch(currentStateH){
                          case 0:
                              finalHeight = 0; break;
                          case 1:
                              finalHeight = roadParam.maxHeight * r(); break;
                          case 2:
                              finalHeight = - roadParam.maxHeight * r(); break;
                      }
                      var finalCurve;
                      switch(currentStateC){
                          case 0:
                              finalCurve = 0; break;
                          case 1:
                              finalCurve = - roadParam.maxCurve * r(); break;
                          case 2:
                              finalCurve = roadParam.maxCurve * r(); break;
                      }

                      for(var i=0; i < roadParam.zoneSize; i++){
                          // add a tree
                          if(r() < 0.25) {
                              var spriteType = tree;//([tree,rock])[Math.floor(r()*1.9)];
                              var sprite = {type: spriteType, pos: 1 + 4*r()};
                              if(r() < 0.5){
                                  sprite.pos = -sprite.pos;
                              }
                          } else {
                              var sprite = false;
                          }
                          road.push({
                              height: currentHeight+finalHeight / 2 * (1 + Math.sin(i/roadParam.zoneSize * Math.PI-Math.PI/2)),
                              curve: currentCurve+finalCurve / 2 * (1 + Math.sin(i/roadParam.zoneSize * Math.PI-Math.PI/2)),
                              sprite: sprite
                          })
                      }
                      if (zones % 4 === 0 && zones !== 0) {
                          var sprite = {type: billboards.shift(), pos: (Math.random() > 0.5 ? 1.55 : -0.55)};
                          road.push({
                              height: currentHeight+finalHeight / 2 * (1 + Math.sin(i/roadParam.zoneSize * Math.PI-Math.PI/2)),
                              curve: currentCurve+finalCurve / 2 * (1 + Math.sin(i/roadParam.zoneSize * Math.PI-Math.PI/2)),
                              sprite: sprite
                          });
                      }
                      currentHeight += finalHeight;
                      currentCurve += finalCurve;
                      // Find next zone
                      if(r() < roadParam.mountainy){
                          currentStateH = transitionH[currentStateH][1+Math.round(r())];
                      } else {
                          currentStateH = transitionH[currentStateH][0];
                      }
                      if(r() < roadParam.curvy){
                          currentStateC = transitionC[currentStateC][1+Math.round(r())];
                      } else {
                          currentStateC = transitionC[currentStateC][0];
                      }
                  }
                  roadParam.length = roadParam.length * roadParam.zoneSize;
              };

              return {
                  start: function(){
                      init();
                      spritesheet = new Image();
                      spritesheet.onload = function(){
                          splashInterval = setInterval(renderSplashFrame, 30);
                          // initFinish();
                      };
                      spritesheet.src = "spritesheet.high.2.png";
                  }
              }
          }());
          $(function(){
              game.start();
          });
        </script>
    </body>
</html>
